<!doctype html>
<html>

<head>

  <title>
    
      Platform configuration | ZHANG Fangli
    
  </title>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/syntax.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Quattrocento+Sans">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">

  <script type="text/javascript" async
    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
  </script>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-102082551-2', 'auto');
  ga('send', 'pageview');

</script>


</head>


<body>

  <div class="container">
    <header class="masthead">
  <h3 class="masthead-title">
    <a href="/">ZHANG Fangli</a>
    <small class="masthead-subtitle">☜ 张方利</small>
    <div class="menu">
  <nav class="menu-content">
    
      <a href="/menu/about.html">About</a>
    
      <a href="/menu/cv.html">Vitae</a>
    
      <a href="/menu/publication.html">Publication</a>
    
      <a href="/menu/blog.html">Blog</a>
    
      <a href="/menu/contact.html">Contact</a>
    
  </nav>
  <nav class="social-icons">
    
  </nav>
</div>

  </h3>
</header>


    <div class="post-container">
      <h1>
  Platform configuration
</h1>


  <img src="/assets/img/input-output.png">


<h2 class="no_toc" id="particle-set-a-parallel-tool-for-runoff-routing">Particle-set: a parallel tool for runoff routing</h2>
<p>by Fangli ZHANG, Qiming ZHOU and Jun LIU
<!-- , Qingquan LI, Guofeng WU,  --></p>

<p><strong>More information on:</strong>
<a href="http://zhangfangli.cn">www.zhangfangli.cn</a></p>

<p><em>Latest revision:</em> (2017-07-06).</p>

<p>The transportation platform is a MPI parallel computing prototype for real-time simulation of surface flow transportation.</p>

<h3 class="no_toc" id="table-of-contents">Table of Contents</h3>

<ol id="markdown-toc">
  <li><a href="#overview" id="markdown-toc-overview">Overview</a></li>
  <li><a href="#system-requirements" id="markdown-toc-system-requirements">System Requirements</a></li>
  <li><a href="#environment-deployment" id="markdown-toc-environment-deployment">Environment Deployment</a></li>
  <li><a href="#experimental-plan" id="markdown-toc-experimental-plan">Experimental plan</a></li>
  <li><a href="#main-contributions" id="markdown-toc-main-contributions">Main contributions</a></li>
  <li><a href="#linux-commands" id="markdown-toc-linux-commands">Linux commands</a></li>
  <li><a href="#acknowledgements" id="markdown-toc-acknowledgements">Acknowledgements</a></li>
</ol>

<h3 id="overview">Overview</h3>
<p>This tool consists of several modules:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: right">Module  </th>
      <th style="text-align: left">Function</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right"><strong><em>drainage</em></strong>  </td>
      <td style="text-align: left">constructing upstream-downstream flow path networks</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong><em>rainfall</em></strong> </td>
      <td style="text-align: left">loading spatial and temporal rainfall inputs</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong><em>runoff</em></strong> </td>
      <td style="text-align: left">generating and tracing runoff particles</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong><em>accumulation</em></strong> </td>
      <td style="text-align: left">exporting flow maps and time costs</td>
    </tr>
  </tbody>
</table>

<h3 id="system-requirements">System Requirements</h3>
<p>This experimental environment is deployed on:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: right">Requirement  </th>
      <th style="text-align: left">To support</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right"><strong><em>HPC environment</em></strong>  </td>
      <td style="text-align: left">environment configuration (e.g., <a href="https://aws.amazon.com/ec2/">Amazon EC2</a>)</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong><em>cluster instance</em></strong>  </td>
      <td style="text-align: left">high-performance computing (e.g., <a href="https://aws.amazon.com/ec2/instance-types/">m4.16xlarge</a>)</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong><em>operating system</em></strong>  </td>
      <td style="text-align: left">parallel computing (e.g., <a href="http://releases.ubuntu.com/14.04/">Ubuntu Server 14.04 LTS</a>)</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong><em>C-language compiler</em></strong>  </td>
      <td style="text-align: left">program execution (e.g., <a href="https://gcc.gnu.org">GCC 4.8.4</a>)</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong><em>MPI implementation</em></strong>  </td>
      <td style="text-align: left">process communication (e.g., <a href="https://www.mpich.org/downloads/">mpich-3.2</a>)</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong><em>process manager</em></strong>  </td>
      <td style="text-align: left">process management (e.g., <a href="https://www.mpich.org/downloads/">hydra-3.2</a>)</td>
    </tr>
  </tbody>
</table>

<h3 id="environment-deployment">Environment Deployment</h3>

<p>The deployment consists of following five steps:</p>
<ol>
  <li>Ubuntu Server OS installation
    <ul>
      <li>
        <p>machine instance on <a href="https://aws.amazon.com">Amazon web service</a>
<img src="/assets/img/aws/aws_01.png" alt="" /></p>
      </li>
      <li>
        <p>multi-processor instance (hourly fee)
<img src="/assets/img/aws/aws_02.png" alt="" /></p>
      </li>
      <li>
        <p>RSA private key for SSH login (automatic generation)
<img src="/assets/img/aws/aws_03.png" alt="" /></p>
      </li>
      <li>SSH login in with private key and target ip address
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh <span class="nt">-i</span> <span class="s2">"key.pem"</span> ubuntu@54.202.97.199 <span class="o">(</span>ip-address<span class="o">)</span>
</code></pre></div>        </div>
        <p><img src="/assets/img/aws/aws_04.png" alt="" /></p>
      </li>
      <li>check the number of processors (64)
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">grep</span> <span class="s1">'processor'</span> /proc/cpuinfo | sort <span class="nt">-u</span> | wc <span class="nt">-l</span>
</code></pre></div>        </div>
        <p><img src="/assets/img/aws/aws_05.png" alt="" /></p>
      </li>
    </ul>
  </li>
  <li>GCC compiling environment configuration
    <ul>
      <li>get source list of applications updated
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get update
</code></pre></div>        </div>
      </li>
      <li>install gcc complier
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get install gcc
</code></pre></div>        </div>
        <p><img src="/assets/img/aws/aws_09.png" alt="" /></p>
      </li>
      <li>install make complier
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get install make
</code></pre></div>        </div>
        <p><img src="/assets/img/aws/aws_10.png" alt="" /></p>
      </li>
    </ul>
  </li>
  <li>MPICH framework configuration
    <ul>
      <li>send source codes to AWS instance
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scp <span class="nt">-i</span> <span class="s2">"key.pem"</span> mpich-3.2.tar.gz ubuntu@54.202.97.199:/home/ubuntu
</code></pre></div>        </div>
      </li>
      <li>create installation path on AWS instance
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir ~/mpich
</code></pre></div>        </div>
      </li>
      <li>authorize read and write permission
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chmod <span class="nt">-R</span> 777 ~/mpich
</code></pre></div>        </div>
      </li>
      <li>unzip installation files
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">tar </span>xfz mpich-3.2.tar.gz
</code></pre></div>        </div>
      </li>
      <li>get into the source installation files
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~/mpich-3.2
</code></pre></div>        </div>
      </li>
      <li>compiling configuration (only need C language)
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./configure <span class="nt">-prefix</span><span class="o">=</span>/home/ubuntu/mpich <span class="nt">-disable-fortran</span> <span class="nt">-disable-cxx</span>
</code></pre></div>        </div>
      </li>
      <li>compile (after “configuration” completed)
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make
</code></pre></div>        </div>
      </li>
      <li>install (after “make” completed)
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make install
</code></pre></div>        </div>
        <p><img src="/assets/img/aws/aws_11.png" alt="" /></p>
      </li>
    </ul>
  </li>
  <li>HYDRA process manager configuration
    <ul>
      <li>send source codes to AWS instance
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scp <span class="nt">-i</span> <span class="s2">"key.pem"</span> hydra-3.2.tar.gz ubuntu@54.202.97.199:/home/ubuntu
</code></pre></div>        </div>
      </li>
      <li>create installation path on AWS instance
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir ~/hydra
</code></pre></div>        </div>
      </li>
      <li>authorize read and write permission
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chmod <span class="nt">-R</span> 777 ~/hydra
</code></pre></div>        </div>
      </li>
      <li>unzip installation files
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">tar </span>xfz hydra-3.2.tar.gz
</code></pre></div>        </div>
      </li>
      <li>get into the source installation files
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~/hydra-3.2
</code></pre></div>        </div>
      </li>
      <li>compiling configuration (only need C language)
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./configure <span class="nt">-prefix</span><span class="o">=</span>/home/ubuntu/hydra
</code></pre></div>        </div>
      </li>
      <li>compile (after “configuration” completed)
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make
</code></pre></div>        </div>
      </li>
      <li>install (after “make” completed)
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make install
</code></pre></div>        </div>
        <p><img src="/assets/img/aws/aws_12.png" alt="" /></p>
      </li>
    </ul>
  </li>
  <li>parallel environment setups
    <ul>
      <li>configure environment variables
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim ~/.bashrc
</code></pre></div>        </div>
      </li>
      <li>add variables
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#bin</span>
  <span class="nv">MPI_HOME</span><span class="o">=</span>/home/ubuntu/mpich
  <span class="nv">HYDRA_HOST_FILE</span><span class="o">=</span>/home/ubuntu/hydra/hosts
  <span class="nv">PATH</span><span class="o">=</span><span class="nv">$MPI_HOME</span>/bin:<span class="nv">$PATH</span>

  <span class="nb">export </span>MPI_HOME
  <span class="nb">export </span>HYDRA_HOST_FILE
  <span class="nb">export </span>PATH

  <span class="c">#GCC include</span>
  <span class="nv">C_INCLUDE_PATH</span><span class="o">=</span><span class="nv">$C_INCLUDE_PATH</span>:<span class="nv">$MPI_HOME</span>/include
  <span class="nb">export </span>C_INCLUDE_PATH
</code></pre></div>        </div>
      </li>
      <li>configure process manager
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim ~/hydra/hosts
</code></pre></div>        </div>
        <p><img src="/assets/img/aws/aws_13.png" alt="" />
<img src="/assets/img/aws/aws_15.png" alt="" /></p>
      </li>
      <li>set number of processors in cluster
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># host ID: number of processors</span>
ip-54-202-97-199: 64
            ... : ...
ip-54-202-97-191: 64
</code></pre></div>        </div>
        <p><img src="/assets/img/aws/aws_14.png" alt="" /></p>
      </li>
    </ul>
  </li>
</ol>

<h3 id="experimental-plan">Experimental plan</h3>
<ol>
  <li>clone particle-set project
    <ul>
      <li>create workspace
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># on AWS EC2 machine</span>
mkdir ~/aws
chmod <span class="nt">-R</span> 777 ~/aws
</code></pre></div>        </div>
      </li>
      <li>clone <a href="https://github.com">source project from GitHub</a>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#content of source project</span>
+- particle-set                   <span class="c"># root path</span>
      /----- README.md            <span class="c"># configuration guide</span>
      /----- particle.c           <span class="c"># main program</span>
      +----- input                <span class="c"># input file path</span>
              /----- pathnode.in  <span class="c"># flow path nodes</span>
              /----- pathline.in  <span class="c"># flow path segments</span>
              /----- rainfall.in  <span class="c"># flow production</span>
      +----- output               <span class="c"># output file path</span>
              /----- flowmap.out  <span class="c"># dynamic flow maps</span>
              /----- outlet.out   <span class="c"># outlet discharges</span>
              /----- timecost.out <span class="c"># time costs</span>
</code></pre></div>        </div>
      </li>
      <li>screenshot of inputs (e.g., <a href="http://vivoni.asu.edu/tribs/weather.html">Peacheater Creek</a>, November 1996)
<img src="/assets/img/aws/aws_06.png" alt="" /></li>
    </ul>
  </li>
  <li>setup model parameters (e.g., flow velocity, particle density)
    <ul>
      <li>pre-define model parameters
        <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     <span class="c1">// head files and macro definition
</span>     <span class="cp">#include &lt;stdio.h&gt;
</span>     <span class="cp">#include &lt;stdlib.h&gt;
</span>     <span class="cp">#include &lt;string.h&gt;
</span>     <span class="cp">#include &lt;math.h&gt;
</span>     <span class="cp">#include &lt;time.h&gt;
</span>     <span class="cp">#include &lt;mpi.h&gt;
</span>
     <span class="cp">#define NSIZE 50000     // path node limit
</span>     <span class="cp">#define LSIZE 50000     // path line limit
</span>     <span class="cp">#define PSIZE 9999999   // runoff particle limit
</span>     <span class="cp">#define MCELL 200       // flow map scale
</span>
     <span class="cp">#define MEANV 0.034     // average watershed velocity
</span>     <span class="cp">#define DENSITY 30      // runoff particle density
</span></code></pre></div>        </div>
      </li>
      <li>flow path node struct
        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">typedef</span> <span class="n">struct</span><span class="o">{</span>
     <span class="kt">int</span> <span class="n">nPNID</span><span class="o">;</span>    <span class="c1">// unique ID number</span>
     <span class="kt">double</span> <span class="n">fX</span><span class="o">;</span>    <span class="c1">// X coordinate</span>
     <span class="kt">double</span> <span class="n">fY</span><span class="o">;</span>    <span class="c1">// Y coordinate  </span>
     <span class="kt">double</span> <span class="n">fZ</span><span class="o">;</span>    <span class="c1">// Z coordinate</span>

     <span class="kt">double</span> <span class="n">fin</span><span class="o">;</span>   <span class="c1">// in-degrees</span>
     <span class="kt">double</span> <span class="n">fout</span><span class="o">;</span>  <span class="c1">// out-degrees</span>

     <span class="kt">int</span> <span class="n">ntype</span><span class="o">;</span>    <span class="c1">// if a starting node or not</span>
     <span class="kt">int</span> <span class="n">nPPRID</span><span class="o">;</span>   <span class="c1">// precipitation point</span>

     <span class="kt">int</span> <span class="n">nPLID_2</span><span class="o">;</span>  <span class="c1">// next path segment</span>
     <span class="kt">int</span> <span class="n">nPNID_2</span><span class="o">;</span>  <span class="c1">// next path node</span>
<span class="o">}</span><span class="n">PathNode</span><span class="o">;</span>         <span class="c1">// struct of flow path node</span>
</code></pre></div>        </div>
      </li>
      <li>flow path line struct
        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">typedef</span> <span class="n">struct</span><span class="o">{</span>
     <span class="kt">int</span> <span class="n">nPLID</span><span class="o">;</span>          <span class="c1">// unique ID number</span>

     <span class="kt">int</span> <span class="n">nPNID_1</span><span class="o">;</span>        <span class="c1">// from node</span>
     <span class="kt">int</span> <span class="n">nPNID_2</span><span class="o">;</span>        <span class="c1">// to node</span>
     <span class="kt">int</span> <span class="n">nPLID_2</span><span class="o">;</span>        <span class="c1">// next flow path segment</span>

     <span class="kt">int</span> <span class="n">ntype</span><span class="o">;</span>          <span class="c1">// if from a source node</span>

     <span class="kt">double</span> <span class="n">fLength</span><span class="o">;</span>     <span class="c1">// path segment length            double fSlope;      // water surface slope</span>
     <span class="kt">double</span> <span class="n">fVelocity</span><span class="o">;</span>   <span class="c1">// constant flow velocity</span>
     <span class="kt">double</span> <span class="n">fTime</span><span class="o">;</span>       <span class="c1">// constant flow time</span>
<span class="o">}</span><span class="n">PathLine</span><span class="o">;</span>               <span class="c1">// struct of flow path segment</span>
</code></pre></div>        </div>
      </li>
      <li>flow path network struct
        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">typedef</span> <span class="n">struct</span><span class="o">{</span>
     <span class="n">PathNode</span> <span class="o">*</span><span class="n">pNode_List</span><span class="o">;</span>   <span class="c1">// path node list</span>
     <span class="n">PathLine</span> <span class="o">*</span><span class="n">pLine_List</span><span class="o">;</span>   <span class="c1">// path line list</span>

     <span class="kt">int</span> <span class="o">*</span><span class="n">pNid_List</span><span class="o">;</span>         <span class="c1">// node id list</span>
     <span class="kt">int</span> <span class="o">*</span><span class="n">pSNid_List</span><span class="o">;</span>        <span class="c1">// source node id list</span>
     <span class="kt">int</span> <span class="o">*</span><span class="n">pBNid_List</span><span class="o">;</span>        <span class="c1">// basin node id list</span>
     <span class="kt">int</span> <span class="o">*</span><span class="n">pLid_List</span><span class="o">;</span>         <span class="c1">// line id list</span>

     <span class="kt">int</span> <span class="n">nNumNodes</span><span class="o">;</span>          <span class="c1">// number of path nodes</span>
     <span class="kt">int</span> <span class="n">nNumLines</span><span class="o">;</span>          <span class="c1">// number of path segments</span>
     <span class="kt">int</span> <span class="n">nNumSources</span><span class="o">;</span>        <span class="c1">// number of source nodes</span>
     <span class="kt">int</span> <span class="n">nNumBasins</span><span class="o">;</span>         <span class="c1">// number of outlets</span>

     <span class="kt">double</span> <span class="n">fLeft</span><span class="o">;</span>           <span class="c1">// minimal X</span>
     <span class="kt">double</span> <span class="n">fRight</span><span class="o">;</span>          <span class="c1">// maximal X</span>
     <span class="kt">double</span> <span class="n">fTop</span><span class="o">;</span>            <span class="c1">// maximal Y</span>
     <span class="kt">double</span> <span class="n">fBottom</span><span class="o">;</span>         <span class="c1">// minimal Y</span>
 <span class="o">}</span><span class="n">DrainageNet</span><span class="o">;</span>               <span class="c1">// struct of flow path network</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>load rainfall event (e.g., <a href="http://vivoni.asu.edu/tribs/weather.html">Peacheater Creek</a>, November 1996)
    <ul>
      <li>struct of flow production on starting point
        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">typedef</span> <span class="n">struct</span><span class="o">{</span>
     <span class="kt">int</span> <span class="n">nPPRID</span><span class="o">;</span>     <span class="c1">// index of starting node ID</span>
     <span class="kt">double</span> <span class="o">*</span><span class="n">pfPPR</span><span class="o">;</span>  <span class="c1">// rainfall rate list mm/hr</span>
     <span class="kt">int</span> <span class="n">nTimeFrame</span><span class="o">;</span> <span class="c1">// number of frames (list size)</span>
<span class="o">}</span><span class="n">PPRate</span><span class="o">;</span>             <span class="c1">//flow on starting points</span>
</code></pre></div>        </div>
      </li>
      <li>struct of distributed rainfall map
        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">typedef</span> <span class="n">struct</span><span class="o">{</span>
     <span class="n">PPRate</span> <span class="o">*</span><span class="n">pPPR_List</span><span class="o">;</span>  <span class="c1">// list of starting points</span>
     <span class="kt">int</span> <span class="n">nNumPoints</span><span class="o">;</span>     <span class="c1">// number of starting points</span>
     <span class="kt">int</span> <span class="n">nNumFrames</span><span class="o">;</span>     <span class="c1">// number of time frames</span>
<span class="o">}</span><span class="n">PPMap</span><span class="o">;</span>                  <span class="c1">//dynamic rainfall map</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>perform runoff simulation (e.g., time step, spatial scale)
    <ul>
      <li>preset in main program (particle-set.c)
        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     <span class="c1">// from 1996-11-23 00:00 to 11-28 23:00 (144 hours)</span>
     <span class="kt">int</span> <span class="n">nST</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>    <span class="c1">// starting time (first hour)</span>
     <span class="kt">int</span> <span class="n">nIT</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>    <span class="c1">// time interval (1 hour)</span>
     <span class="kt">int</span> <span class="n">nET</span> <span class="o">=</span> <span class="mi">144</span><span class="o">;</span>  <span class="c1">// ending time (last hour)</span>

     <span class="c1">// input file path</span>
     <span class="kt">char</span> <span class="n">strFilePath</span><span class="o">[</span><span class="mi">120</span><span class="o">]</span> <span class="o">=</span> <span class="s">"/home/ubuntu/aws"</span><span class="o">;</span>
     <span class="kt">char</span><span class="o">*</span> <span class="n">pNPath</span> <span class="o">=</span> <span class="n">join_string</span><span class="o">(</span><span class="n">strFilePath</span><span class="o">,</span> <span class="s">"/input/pathnode.in"</span><span class="o">);</span>
     <span class="kt">char</span><span class="o">*</span> <span class="n">pTopoPath</span> <span class="o">=</span> <span class="n">join_string</span><span class="o">(</span><span class="n">strFilePath</span><span class="o">,</span> <span class="s">"/input/pathline.in"</span><span class="o">);</span>
     <span class="kt">char</span><span class="o">*</span> <span class="n">pPPRPath</span> <span class="o">=</span> <span class="n">join_string</span><span class="o">(</span><span class="n">strFilePath</span><span class="o">,</span> <span class="s">"/input/rainfall.in"</span><span class="o">);</span>
</code></pre></div>        </div>
      </li>
      <li>execution of main program (#! /bin/sh)
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     <span class="c"># create batch file</span>
     vim ~/run.sh

     <span class="c"># write commands into batch file</span>
         <span class="c"># empty output files</span>
         rm <span class="nt">-rf</span> ./aws/output/<span class="k">*</span>

         <span class="c"># compiling with MPICH framework</span>
         mpicc <span class="nt">-o</span> ./aws/particle-set ./aws/particle-set.c <span class="nt">-lm</span>
         <span class="c"># executing with increasing processors (... '128')</span>
         <span class="k">for </span>i <span class="k">in</span> <span class="s1">'1'</span> <span class="s1">'2'</span> <span class="s1">'3'</span> <span class="s1">'4'</span><span class="p">;</span>
             <span class="k">do
                 </span>mpiexec <span class="nt">-np</span> <span class="nv">$i</span> ./aws/particle-set
         <span class="k">done</span>

     <span class="c"># save</span>
     :x!

     <span class="c"># run batch file</span>
     /bin/sh ./run.sh | tee ./log.txt
</code></pre></div>        </div>
      </li>
      <li>distributed processors (if on multiple computers)
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     <span class="c"># copy source code and input files</span>
     scp <span class="nt">-r</span> ./aws ubuntu@ip-address_1:/home/
     ...
     scp <span class="nt">-r</span> ./aws ubuntu@ip-address_n:/home/
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>analyze model performance (e.g., accuracy, efficiency)
    <ul>
      <li>get output files from Amazon EC2 instance
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     <span class="c"># on local machine</span>
     scp <span class="nt">-rp</span> <span class="nt">-i</span> <span class="s2">"particle.pem"</span> ubuntu@54.245.145.39:/home/ubuntu/aws/output ~/aws/
</code></pre></div>        </div>
        <p><img src="/assets/img/aws/aws_16.png" alt="" /></p>
      </li>
      <li>prediction accuracy of outlet discharges
        <div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     <span class="c1">%% comparison of outlet discharges</span>

     <span class="c1">% Qh_obs    observed outlet discharges</span>
     <span class="c1">% Qh_ptc    number of particles passing outlet</span>
     <span class="c1">% Qh_sim    simulated outlet discharges</span>
     <span class="n">Qh_obs</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span> <span class="n">observations</span> <span class="p">(</span><span class="n">SWAT</span><span class="p">)];</span>
     <span class="n">Qh_ptc</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span> <span class="n">simulations</span> <span class="p">(</span><span class="n">particles</span><span class="p">)];</span>

     <span class="c1">% 0.1       10 particles per each mm of water</span>
     <span class="c1">% 10^(-3)   from mm to m</span>
     <span class="c1">% 200*200   cell size of constraining grid</span>
     <span class="c1">% 3600      from hour to seconds</span>
     <span class="n">Qh_1</span> <span class="o">=</span> <span class="n">Qh_ptc</span><span class="o">*</span><span class="mf">0.1</span><span class="o">*</span><span class="mi">10</span><span class="o">^</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mi">200</span><span class="o">*</span><span class="mi">200</span><span class="p">/</span><span class="mi">3600</span><span class="p">;</span>
     <span class="n">theta</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">Qh_1</span><span class="p">)</span><span class="o">*</span><span class="nb">min</span><span class="p">(</span><span class="n">Qh_obs</span><span class="p">)</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">Qh_1</span><span class="p">)</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">Qh_obs</span><span class="p">))/(</span><span class="nb">max</span><span class="p">(</span><span class="n">Qh_1</span><span class="p">)</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">Qh_1</span><span class="p">));</span>
     <span class="n">e</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">Qh_obs</span><span class="p">)</span><span class="o">-</span><span class="n">theta</span><span class="p">)/</span><span class="nb">max</span><span class="p">(</span><span class="n">Qh_1</span><span class="p">);</span>
     <span class="n">Qh_sim</span> <span class="o">=</span> <span class="n">Qh_1</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="n">theta</span><span class="p">;</span>

     <span class="c1">%% calculation of quantitative indicators</span>

     <span class="c1">% peak discharge</span>
     <span class="n">p_o</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Qh_obs</span><span class="p">);</span>
     <span class="n">p_s</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Qh_sim</span><span class="p">);</span>

     <span class="c1">% Nash and Sutcliffe efficiency</span>
     <span class="nb">diff</span><span class="o">=</span><span class="n">observed</span><span class="o">-</span><span class="n">simulated</span><span class="p">;</span>
     <span class="n">diffmean_o</span><span class="o">=</span><span class="n">observed</span><span class="o">-</span><span class="nb">mean</span><span class="p">(</span><span class="n">Qh_obs</span><span class="p">);</span>
     <span class="n">diffmean_s</span><span class="o">=</span><span class="n">simulated</span><span class="o">-</span><span class="nb">mean</span><span class="p">(</span><span class="n">Qh_sim</span><span class="p">);</span>

     <span class="n">nse</span><span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nb">diff</span><span class="o">.^</span><span class="mi">2</span><span class="p">))/(</span><span class="nb">sum</span><span class="p">(</span><span class="n">diffmean_o</span><span class="o">.^</span><span class="mi">2</span><span class="p">));</span>

     <span class="c1">% correlation coefficient r</span>
     <span class="n">r</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">diffmean_o</span><span class="o">.*</span><span class="n">diffmean_s</span><span class="p">)/</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">diffmean_o</span><span class="o">.^</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">diffmean_s</span><span class="o">.^</span><span class="mi">2</span><span class="p">));</span>

     <span class="c1">% balance coefficient</span>
     <span class="n">b</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Qh_obs</span><span class="p">)/</span><span class="nb">sum</span><span class="p">(</span><span class="n">Qh_sim</span><span class="p">);</span>
</code></pre></div>        </div>
      </li>
      <li>result example of prediction accuracy
<img src="/assets/img/aws/aws_07.png" alt="" /></li>
      <li>simulation efficiency of runoff routing
        <div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     <span class="c1">%% comparison of time costs varying multiple processors</span>

     <span class="c1">% experimental speedup ratio</span>
     <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">;</span>
     <span class="n">num_cpu</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">^</span><span class="n">num</span><span class="p">;</span> <span class="c1">% from 1 to 128</span>
     <span class="n">time_cost</span> <span class="o">=</span> <span class="p">[</span><span class="n">longest</span> <span class="nb">time</span> <span class="n">cost</span> <span class="n">on</span> <span class="n">multiple</span> <span class="n">processors</span><span class="p">];</span>
     <span class="k">for</span> <span class="nb">i</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="nb">length</span><span class="p">(</span><span class="n">num_cpu</span><span class="p">)</span>
         <span class="n">speed_up</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">time_cost</span><span class="p">(</span><span class="nb">i</span><span class="p">)/</span><span class="n">time_cost</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
     <span class="k">end</span>

     <span class="c1">% theoretical speedup ratio (parallel portion)</span>
     <span class="n">ideal_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">:</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">7</span><span class="p">;</span>
     <span class="n">ideal_s</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">^</span><span class="n">ideal_x</span><span class="p">;</span>
     <span class="n">ideal_y1</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">/((</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mf">1.</span><span class="p">/</span><span class="n">ideal_s</span><span class="p">);</span>
     <span class="n">ideal_y2</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">/((</span><span class="mi">1</span><span class="o">-</span><span class="mf">0.99</span><span class="p">)</span><span class="o">+</span><span class="mf">0.99</span><span class="o">.</span><span class="p">/</span><span class="n">ideal_s</span><span class="p">);</span>
     <span class="n">ideal_y3</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">/((</span><span class="mi">1</span><span class="o">-</span><span class="mf">0.95</span><span class="p">)</span><span class="o">+</span><span class="mf">0.95</span><span class="o">.</span><span class="p">/</span><span class="n">ideal_s</span><span class="p">);</span>
     <span class="n">f</span> <span class="o">=</span> <span class="n">fittype</span><span class="p">(</span><span class="s1">'1/1/((1-a)+a/x)'</span><span class="p">,</span><span class="s1">'dependent'</span><span class="p">,{</span><span class="s1">'y'</span><span class="p">},</span><span class="s1">'independent'</span><span class="p">,{</span><span class="s1">'x'</span><span class="p">},</span><span class="s1">'coefficients'</span><span class="p">,{</span><span class="s1">'a'</span><span class="p">});</span>
     <span class="p">[</span><span class="n">fitresult</span><span class="p">,</span> <span class="n">gof</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="p">(</span><span class="n">num_cpu</span><span class="s1">',speed_up(:)'</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span><span class="s1">'start'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</code></pre></div>        </div>
      </li>
      <li>result example of simulation efficiency
<img src="/assets/img/aws/aws_08.png" alt="" /></li>
    </ul>
  </li>
</ol>

<h3 id="main-contributions">Main contributions</h3>
<ul>
  <li>
    <p>realistic representation of surface water movements
<img src="/assets/img/aws/aws_17.gif" width="350" /></p>
  </li>
  <li>
    <p>high-performance computation of rainfall-runoff modeling
<img src="/assets/img/aws/aws_18.png" width="350" /></p>
  </li>
  <li>
    <p>unified description of watershed physical mechanisms
<img src="/assets/img/aws/aws_19.png" width="350" /></p>

    <script type="math/tex; mode=display">{v_m = f_1(\text{topographical, geographical and hydrological factors)}}</script>

    <script type="math/tex; mode=display">{R = f_2(\text{upstream area)}}</script>

    <script type="math/tex; mode=display">{S = f_3(\text{water surface slope})}</script>

    <script type="math/tex; mode=display">{v = v_m \cdot {\frac{R^\beta\cdot S^{0.5}}{E{\left(R^\beta \cdot S^{0.5}\right)}}}}</script>

    <script type="math/tex; mode=display">{q = f_4(\lambda, v, e)}</script>

    <script type="math/tex; mode=display">{q(t) = \int_0^t A(i)\cdot Q(t-i) \,di}</script>

    <script type="math/tex; mode=display">{q(t) = q(t)\cdot(1-e)+\lambda}</script>
  </li>
</ul>

<h3 id="linux-commands">Linux commands</h3>
<ul>
  <li>connect to Amazon EC2 instance
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="c"># ensure the private key key.pem is assessible</span>
   <span class="nb">cd</span> ~
   chmod 400 key.pem
   ssh <span class="nt">-i</span> <span class="s2">"key.pem"</span> ubuntu@ip-address
</code></pre></div>    </div>
  </li>
  <li>turn off firewall
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="c"># after login in AWS instance</span>
   <span class="nb">sudo </span>ufw disable
</code></pre></div>    </div>
  </li>
  <li>send file and directory to Amazon EC2 instance
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="c"># on local machine</span>

   <span class="c"># send file</span>
   scp <span class="nt">-i</span> <span class="s2">"key.pem"</span> file ubuntu@ip-address:/home/ubuntu

   <span class="c"># send directory</span>
   scp <span class="nt">-i</span> <span class="s2">"key.pem"</span> <span class="nt">-r</span> directory ubuntu@ip-address:/home/ubuntu
</code></pre></div>    </div>
  </li>
  <li>get file and directory from Amazon EC2 instance
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>       <span class="c"># get file</span>
       scp <span class="nt">-p</span> <span class="nt">-i</span> <span class="s2">"particle.pem"</span> ubuntu@54.245.145.39:/pathto/file ~/local_path

       <span class="c"># get directory</span>
       scp <span class="nt">-rp</span> <span class="nt">-i</span> <span class="s2">"particle.pem"</span> ubuntu@54.245.145.39:/pathto/directort ~/local_path
</code></pre></div>    </div>
  </li>
  <li>delete file and directory on AWS instance
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="c"># delete file</span>
      rm ~/<span class="o">(</span>file path<span class="o">)</span>

      <span class="c"># delete file</span>
      rm <span class="nt">-rf</span> ~/<span class="o">(</span>directory path<span class="o">)</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="acknowledgements">Acknowledgements</h3>
<p>Special thanks to <a href="http://vivoni.asu.edu/tribs.html">Valeriy Y. Ivanov et al., 2004</a>, <a href="http://www.pihm.psu.edu/announcement_20141026.html">Yizhong Qu and Christopher J. Duffy 2007</a>, and <a href="http://www.tandfonline.com/doi/abs/10.1080/13658816.2014.917312">Yumin Chen et al., 2014</a>, for their antecedent efforts and achievements on TIN-based hydrological modeling applications. Additionally, we are very grateful for the computing resources provided by <a href="https://aws.amazon.com/ec2/">Amazon web services</a>.</p>


<span class="post-date">
  Written on
  
  July
  1st
    ,
  2017
  by
  
    Fangli ZHANG
  
</span>
<!-- <div class="post-date">Feel free to share!</div>
  <div class="sharing-icons">
    <a href="https://twitter.com/intent/tweet?text=Platform configuration&amp;url=/journal/platform-configuration.html&amp;via=funtry@qq.com" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a>
    <a href="https://www.facebook.com/sharer/sharer.php?u=/journal/platform-configuration.html&amp;title=Platform configuration" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i></a>
    <a href="https://plus.google.com/share?url=/journal/platform-configuration.html" target="_blank"><i class="fa fa-google-plus" aria-hidden="true"></i></a>
  </div>
</div>
 -->
<div class="related">
  <h3 >You may also enjoy:</h3>
  
  <ul class="related-posts">
    
      
        
          <li>
            <h4>
              <a href="/journal/one-belt-one-road.html">
                One Belt One Road
                <!--<img src="http://localhost:4000/images/one-belt-one-road.png">-->
                <!--<small>December 1, 2017</small>-->
              </a>
            </h4>
          </li>
          
        
      
        
        
      
        
          <li>
            <h4>
              <a href="/journal/runoff-transportation.html">
                Runoff transportation
                <!--<img src="http://localhost:4000/images/platform.gif">-->
                <!--<small>June 1, 2017</small>-->
              </a>
            </h4>
          </li>
          
        
      
    
      
        
        
      
        
        
      
        
        
      
    
  </ul>
</div>




    </div>

    <footer class="footer">
  
  <div class="post-date"><a href="/menu/about.html">ZHANG Fangli | ☜ 张方利 by funtry</a></div>
</footer>


  </div>

</body>
</html>
